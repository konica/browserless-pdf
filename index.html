<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>F2 Integration</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v10.6.0/ol.css"
    />
  </head>
  <body>
    <div id="app">
      <div class="map-container">
        <div ref="mapContainer" id="map"></div>
      </div>
      <div class="info-section">
        <div class="general-info">
          <h2>Project information</h2>
          <div class="project-details">
            <div class="info-item">
              <strong>Name:</strong> 游봇 MST - DDH - Delete - 1
            </div>
            <div class="info-item"><strong>Description:</strong> N/A</div>
            <div class="info-item"><strong>Version:</strong> 1</div>
            <div class="info-item"><strong>Created:</strong> 2023-01-01</div>
            <div class="info-item"><strong>Updated:</strong> 2023-01-02</div>
            <div class="info-item">
              <strong>Last state changed:</strong> 2023-01-03
            </div>
            <div class="info-item">
              <strong>Link to Project:</strong>
              <a
                href="https://mars.udv.sgav.dk/projects/402a966e-6d9f-41ff-9bda-23cc55ba5d76"
                target="_blank"
                class="project-link"
                >https://mars.udv.sgav.dk/projects/402a966e-6d9f-41ff-9bda-23cc55ba5d76
              </a>
            </div>
            <div class="info-item">
              <strong>Creator:</strong> USa_MST_ MARS_Planl칝gger (Milj칮styrelsen - DK25798376)
            </div>
            <div class="info-item">
              <strong>Owner:</strong> Milj칮styrelsen (DK25798376)
            </div>
          </div>

          <h2>Subsidy scheme</h2>
          <div class="subsidy-details">
            <div class="info-item">
              <strong>Name:</strong> Kv칝lstofv친domr친der
            </div>
            <div class="info-item">
              <strong>Description:</strong> Du kan s칮ge tilskud til at lave et
              kv칝lstofv친domr친de under Styrelsen for Gr칮n Arealoml칝gning og
              Vandmilj칮s ordning til Vand- og Klimaprojekter. Et
              kv칝lstofv친domr친de har til form친l at genskabe naturlige
              vandforhold, s친 udledningen af kv칝lstof til vores kystvande,
              fjorde og s칮er mindskes. Kv칝lstofv친domr친deordningen kan s칮ges af
              kommuner og Naturstyrelsen, som gennemf칮rer projekterne gennem
              frivillige aftaler med lodsejere.
            </div>
            <div class="info-item"><strong>Organization:</strong> SGAV</div>
            <div class="info-item"><strong>Owner VAT:</strong> DK20814616</div>
            <div class="info-item"><strong>Active:</strong> Yes</div>
            <div class="info-item">
              <strong>URL:</strong>
              <a
                href="https://sgavmst.dk/tilskud/tilskud-til-vand-og-klimaprojekter/kvaelstof-og-fosforvaadomraader"
                target="_blank"
                class="project-link"
                >https://sgavmst.dk/tilskud/tilskud-til-vand-og-klimaprojekter/kvaelstof-og-fosforvaadomraader
              </a>
            </div>
            <div class="info-item">
              <strong>Mitigation measure:</strong> Kv칝lstofv친domr친der
            </div>
          </div>

          <h2>Project Effects</h2>
          <div class="effects-details">
            <div class="info-item">
              <strong>Nitrogen reduction:</strong> 0.971 tons
            </div>
            <div class="info-item">
              <strong>Extraction effort:</strong> 27.58 ha
            </div>
            <div class="info-item">
              <strong>Afforestation effort:</strong> 0.25 ha
            </div>
          </div>

          <h2>Forest</h2>
          <div class="forest-details">
            <table class="forest-table">
              <thead>
                <tr>
                  <th>BFE nummer</th>
                  <th>Matrikelnummer</th>
                  <th>Areal</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>9065681</td>
                  <td>1a</td>
                  <td>0,2 ha</td>
                </tr>
                <tr>
                  <td>9065681</td>
                  <td>1o</td>
                  <td>1 ha</td>
                </tr>
                <tr>
                  <td>9065681</td>
                  <td>1p</td>
                  <td>0,6 ha</td>
                </tr>
                <tr>
                  <td>9065682</td>
                  <td>1b</td>
                  <td>0,2 ha</td>
                </tr>
              </tbody>
            </table>
          </div>

          <h2>Untouched forest</h2>
          <div class="untouched-forest-details">
            <table class="forest-table">
              <thead>
                <tr>
                  <th>BFE nummer</th>
                  <th>Matrikelnummer</th>
                  <th>Areal</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>9065681</td>
                  <td>1a</td>
                  <td>0,2 ha</td>
                </tr>
                <tr>
                  <td>9065681</td>
                  <td>1o</td>
                  <td>1 ha</td>
                </tr>
                <tr>
                  <td>9065681</td>
                  <td>1p</td>
                  <td>0,6 ha</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.6.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.8.0/dist/proj4.js"></script>
    <script>
      // Declare the project variable
      const project = {        
        mitigationColor: "rgba(0, 61, 35, 1)", // Example color for the project
        geometryWkt:
          "MULTIPOLYGON (((536848.5353188185 6346864.170815518, 535613.6147526584 6347336.0288243815, 536478.9213975612 6348476.804757819, 537180.4315420579 6348292.5509164715, 536848.5353188185 6346864.170815518)))",
        snapshotGeometryWkt:
          "MULTIPOLYGON (((536618.7629581506 6347131.985142916, 535899.5790435629 6347431.573652884, 536478.9213975612 6348476.804757819, 537138.1733192666 6348110.641003096, 536618.7629581506 6347131.985142916)))",
      };

      // Define EPSG:25832 projection (UTM Zone 32N, ETRS89)
      proj4.defs(
        "EPSG:25832",
        "+proj=utm +zone=32 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
      );
      ol.proj.proj4.register(proj4);

      const mapZoomPaddingPx = 20; // Padding for zooming
      const extent = [230000, 6025000, 905000, 6450000]; // Map extent for Denmark in EPSG:25832

      // Function to load layers from data catalog
      async function loadLayersFromCatalog() {
        try {
          // Create layers from the catalog data using URLs from targetLayers
          const targetLayers = [
            "urn:dmp:ds:skaermkort-daempet",
          ];

          // Build params object
          const params = {
            include: [
              "thumbnail",
              "wfsSource",
              "wmsSource.legends.image",
              "wmtsSource.legends.image",
              "license",
              "dataLiabilityAgreement",
              "previewImages.image",
              "livePreviews.previewImage",
              "owners.thumbnail",
              "related",
              "tags",
              "category.thumbnail",
            ].join(","),
            filter: `any(id,${targetLayers
              .map((id) => `%27${encodeURIComponent(id)}%27`)
              .join(",")})`,
            locale: "da-DK",
            orgname: "MST",
            appname: "MARS",
            appurlname: encodeURIComponent("https://mars.sgav.dk"),
            componentname: encodeURIComponent("@dmp/map-components"),
          };

          // Build query string from params object
          const queryString = Object.entries(params)
            .map(([key, value]) => `${key}=${value}`)
            .join("&");

          const catalogUrl = `https://datakatalog.miljoeportal.dk/api/datasets?${queryString}`;

          const response = await fetch(catalogUrl, {
            method: "GET",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Find WMS and WMTS sources in the included data
          const wmsSources =
            data.included?.filter((item) => item.type === "wmsSources") || [];
          const wmtsSources =
            data.included?.filter((item) => item.type === "wmtsSources") || [];

          targetLayers.forEach((layerId) => {
            console.log(`Processing layer: ${layerId}`);
            const dataset = data.data.find((item) => item.id === layerId);

            if (dataset) {
              console.log(`Found dataset: ${dataset.attributes.title}`);
              let layer = null;

              // Try to create WMTS layer first (faster)
              if (dataset.relationships?.wmtsSource?.data) {
                const wmtsSourceId = dataset.relationships.wmtsSource.data.id;
                const wmtsSource = wmtsSources.find(
                  (source) => source.id === wmtsSourceId
                );

                if (wmtsSource) {
                  try {
                    // Parse extent from the wmtsSource
                    const extentString = wmtsSource.attributes.extent;
                    let extent = null;
                    if (extentString) {
                      extent = extentString.split(",").map(Number);
                    }

                    layer = new ol.layer.Tile({
                      source: new ol.source.WMTS({
                        url: wmtsSource.attributes.url,
                        layer: wmtsSource.attributes.layer,
                        matrixSet: wmtsSource.attributes.matrixSet,
                        format: wmtsSource.attributes.format,
                        style: wmtsSource.attributes.style || "default",
                        tileGrid: new ol.tilegrid.WMTS({
                          origin: extent
                            ? [extent[0], extent[3]]
                            : [120000, 6500000], // Use extent or default
                          resolutions: wmtsSource.attributes.resolutions
                            .split(",")
                            .map(Number),
                          matrixIds: wmtsSource.attributes.matrixIds.split(","),
                          extent: extent,
                        }),
                      }),
                      visible: true,
                      opacity: 1.0,
                    });
                  } catch (wmtsError) {
                    console.error(
                      `Error creating WMTS layer: ${wmtsError.message}`
                    );
                  }
                }
              }

              // Add the layer to the map if created successfully
              if (layer) {
                map.addLayer(layer);
                console.log(
                  `Successfully added layer: ${dataset.attributes.title}`
                );
              } else {
                console.warn(`Could not create layer for: ${layerId}`);
              }
            } else {
              console.warn(`Dataset not found for: ${layerId}`);
            }
          });

          console.log(`Total layers loaded: ${map.getLayers().getLength()}`);
        } catch (error) {
          console.error("Error loading layers from catalog:", error);
        }
      }

      async function loadProjectGeometry() {
        return new Promise(async (resolve, reject) => {
          try {
            // Parse the WKT geometry for the main project geometry
            const wktFormat = new ol.format.WKT();
            const geometry = wktFormat.readGeometry(project.geometryWkt, {
              dataProjection: "EPSG:25832",
              featureProjection: "EPSG:25832",
            });

            const mitigationColor = project.mitigationColor;
            // Create a vector layer for the project geometry
            const projectLayer = new ol.layer.Vector({
              source: new ol.source.Vector({
                features: [new ol.Feature(geometry)],
              }),
              zIndex: 1010,
              style: getProjectStyle(mitigationColor),
            });

            map.addLayer(projectLayer);

            // Zoom to the extent of the project geometry
            const extent = geometry.getExtent();
            zoomMaptoExtent(map, extent);
            resolve(true);
          } catch (error) {
            console.error("Error loading project geometry:", error);
            reject(error);
          }
        });
      }

      function zoomMaptoExtent(map, extent) {
        map.getView().fit(extent, {
          minResolution: 0.2,
          padding: [
            mapZoomPaddingPx,
            mapZoomPaddingPx,
            mapZoomPaddingPx,
            mapZoomPaddingPx,
          ],
          duration: 0,
          nearest: true,
        });
      }
      // #endregion

      // #region Style Management

      const defaultStrokeWidth = 2;
      const whiteStrokeWidth = 6;
      const hoverOpacity = 0.5; // 0.5 default hover opacity
      const selectedOpacity = 0.2; // 0.2 default select opacity

      const whiteColor = [255, 255, 255, 1];
      const transparentFill = [0, 255, 255, 0];
      const defaultStrokeColor = [23, 94, 123, 1];
      const modifyPointColor = [40, 120, 118, 0.3];
      const projectNoVirkemiddelColor = [11, 45, 59, 1];
      const defaultFillColor = defaultStrokeColor.with(3, 0.05);

      function getProjectStyle(color) {
        const strokeNums =
          typeof color === "string" ? ol.color.fromString(color) : color;
        return [
          new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: strokeNums,
              width: 3,
            }),
            fill: new ol.style.Fill({
              color: strokeNums.with(3, 0.3),
            }),
            zIndex: 2,
          }),
          new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: whiteColor,
              width: 8,
            }),
            zIndex: 1,
          }),
        ];
      }

      function getSnapshotProjectStyle(strokeColor) {
        return [
          new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: strokeColor,
              width: 3,
              lineDash: [15, 10],
            }),
            fill: new ol.style.Fill({
              color: transparentFill,
            }),
            zIndex: 2,
          }),
          new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: whiteColor,
              width: 8,
            }),
            zIndex: 1,
          }),
        ];
      }

      // #endregion
      async function readyForPDFFunc(timeoutMs = 30000) {
        return new Promise((resolve, reject) => {
          // Check if already ready
          if (readyForPDF) {
            resolve(true);
            return;
          }

          let timeoutId = null;
          let intervalId = null;
          let startTime = Date.now();

          // Cleanup function to prevent memory leaks
          const cleanup = () => {
            if (timeoutId) {
              clearTimeout(timeoutId);
              timeoutId = null;
            }
            if (intervalId) {
              clearInterval(intervalId);
              intervalId = null;
            }
          };

          // Set up timeout to prevent infinite waiting
          timeoutId = setTimeout(() => {
            cleanup();
            reject(new Error(`readyForPDF timeout after ${timeoutMs}ms`));
          }, timeoutMs);

          // Use setInterval instead of recursive setTimeout for better performance
          intervalId = setInterval(() => {
            if (readyForPDF) {
              cleanup();
              resolve(true);
            } else {
              // Additional safety check for elapsed time
              const elapsed = Date.now() - startTime;
              if (elapsed >= timeoutMs) {
                cleanup();
                reject(new Error(`readyForPDF timeout after ${elapsed}ms`));
              }
            }
          }, 100);
        });
      }

      // Create the map variable (will be initialized in Vue)
      let map;
      let readyForPDF = false;

      // Expose map and readyForPDFFunc to global scope for PDF generation
      window.readyForPDFFunc = readyForPDFFunc;

      // Create a map view
      const view = new ol.View({
        center: [665690, 6237500],
        extent: extent,
        projection: "EPSG:25832", // Use EPSG:25832 for Danish data
        zoom: 1,
      });

      map = new ol.Map({
        target: "map",
        layers: [],
        view: view,
      });

      // Expose map to global scope for PDF generation
      window.map = map;

      // Initialize the map after Vue is mounted to ensure DOM is ready
      loadLayersFromCatalog()
        .then(() => {
          console.log("Layers loaded successfully");
          loadProjectGeometry().then(() => {
            if (map && map.getView() && map.getLayers().getLength() > 0) {
              // Wait for the next render complete event to ensure all layers are loaded
              map.once("rendercomplete", () => {
                readyForPDF = true;
                console.log("Map is ready for PDF generation");
              });

              // Force a re-render to trigger the event
              map.getView().changed();
            } else {
              // If map isn't ready yet, wait a bit and try again
              setTimeout(() => {
                readyForPDF().then(resolve);
              }, 100);
            }
          });
        })
        .catch((error) => {
          console.error("Error loading layers:", error);
        });
    </script>
    <style type="text/css">
      /* Reset and base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.6;
        color: #333;
      }

      #app {
        display: flex;
        flex-direction: column;
      }

      /* Map styles */
      .map-container {
        width: 100%;
      }

      #map {
        width: 100%;
        height: 300px;
      }

      /* Info section styles */
      .info-section {
        margin-top: 1rem;
      }

      .general-info {
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .general-info h2 {
        margin-bottom: 1rem;
        font-size: 1.5rem;
      }

      .project-details,
      .subsidy-details,
      .effects-details,
      .forest-details,
      .untouched-forest-details {
        margin-bottom: 2rem;
      }

      .info-item {
        margin-bottom: 0.5rem;
        line-height: 1.5;
      }

      .info-item strong {
        font-weight: 600;
        color: #212529;
      }

      .description-box {
        margin-top: 0.25rem;
        padding: 0.5rem;
        border-radius: 4px;
      }

      /* Table styles */
      .forest-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
      }

      .forest-table th,
      .forest-table td {
        padding: 8px 12px;
        text-align: left;
        border: 1px solid #ddd;
      }

      .forest-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #212529;
      }

      .forest-table tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      .forest-table tbody tr:hover {
        background-color: #e9ecef;
      }
    </style>
  </body>
</html>
